# TRADè‚¡ç¥¨ç›‘æ§VSCodeæ’ä»¶è®¾è®¡æ–¹æ¡ˆ

## é¡¹ç›®æ¦‚è¿°

åŸºäºç°æœ‰çš„`stock_profit_calculator.py`è„šæœ¬ï¼Œå¼€å‘ä¸€ä¸ªVSCodeæ’ä»¶ï¼Œå®ç°Aè‚¡è‚¡ç¥¨çš„å®æ—¶ç›ˆäºç›‘æ§åŠŸèƒ½ã€‚æ’ä»¶æä¾›å‹å¥½çš„å›¾å½¢ç•Œé¢ï¼Œæ”¯æŒé…ç½®ç®¡ç†ã€å®æ—¶æ•°æ®æ›´æ–°ï¼ˆæ¯20ç§’ï¼‰å’Œæ‰‹åŠ¨æ§åˆ¶ã€‚

### æ ¸å¿ƒéœ€æ±‚
1. **å®æ—¶æ›´æ–°**ï¼šæ¯20ç§’è‡ªåŠ¨åˆ·æ–°è‚¡ç¥¨æ•°æ®
2. **é…ç½®ç®¡ç†**ï¼šæ”¯æŒæ·»åŠ /ç¼–è¾‘/åˆ é™¤è‚¡ç¥¨é…ç½®ï¼ˆä»£ç ã€ä¹°å…¥ä»·ã€æ•°é‡ï¼‰
3. **æ§åˆ¶åŠŸèƒ½**ï¼šä¸€é”®å¼€å§‹/åœæ­¢ç›‘æ§
4. **å¯è§†åŒ–æ˜¾ç¤º**ï¼šåœ¨VSCodeä¾§è¾¹æ æ¸…æ™°å±•ç¤ºç›ˆäºä¿¡æ¯
5. **æœ¬åœ°è¿è¡Œ**ï¼šæ— éœ€å¤–éƒ¨æœåŠ¡ï¼Œå®Œå…¨æœ¬åœ°åŒ–

## ç³»ç»Ÿæ¶æ„

### æ•´ä½“æ¶æ„å›¾
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            VSCode Extension                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ TreeView    â”‚  â”‚ Webview Config     â”‚   â”‚
â”‚  â”‚ è‚¡ç¥¨åˆ—è¡¨æ˜¾ç¤º  â”‚  â”‚ é…ç½®ç®¡ç†ç•Œé¢       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚          â”‚                     â”‚            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚      TypeScript Extension Core       â”‚   â”‚
â”‚  â”‚  â€¢ çŠ¶æ€ç®¡ç†                          â”‚   â”‚
â”‚  â”‚  â€¢ å®šæ—¶å™¨(20s)                       â”‚   â”‚
â”‚  â”‚  â€¢ Pythonè¿›ç¨‹é€šä¿¡                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚          â”‚ IPC (JSON-RPC over stdio)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Python Data Daemon                  â”‚
â”‚  â€¢ å¼‚æ­¥æ•°æ®è·å–å¼•æ“                         â”‚
â”‚  â€¢ ç¼“å­˜ç®¡ç†                                â”‚
â”‚  â€¢ å®æ—¶ç›ˆäºè®¡ç®—                            â”‚
â”‚  â€¢ é…ç½®æŒä¹…åŒ–                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æŠ€æœ¯æ ˆ
- **å‰ç«¯**ï¼šTypeScript + VSCode Extension API
- **åç«¯**ï¼šPython 3.8+ (asyncio, akshare, aiohttp)
- **é€šä¿¡**ï¼šJSON-RPC over stdio
- **é…ç½®**ï¼šJSONæ–‡ä»¶å­˜å‚¨

## è¯¦ç»†è®¾è®¡

### 1. ç›®å½•ç»“æ„
```
trad-vscode-plugin/
â”œâ”€â”€ .vscode/                    # VSCodeè°ƒè¯•é…ç½®
â”œâ”€â”€ src/                        # TypeScriptæºä»£ç 
â”‚   â”œâ”€â”€ extension.ts            # æ’ä»¶ä¸»å…¥å£
â”‚   â”œâ”€â”€ stockProvider.ts        # TreeDataProvider
â”‚   â”œâ”€â”€ configManager.ts        # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ pythonClient.ts         # Pythonè¿›ç¨‹é€šä¿¡
â”‚   â”œâ”€â”€ stateManager.ts         # çŠ¶æ€ç®¡ç†
â”‚   â”œâ”€â”€ views/                  # UIç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ stockView.ts        # è‚¡ç¥¨æ ‘è§†å›¾
â”‚   â”‚   â””â”€â”€ configWebview.ts    # é…ç½®Webview
â”‚   â””â”€â”€ types/                  # ç±»å‹å®šä¹‰
â”‚       â”œâ”€â”€ stock.ts
â”‚       â””â”€â”€ config.ts
â”œâ”€â”€ scripts/                    # Pythonåç«¯
â”‚   â”œâ”€â”€ stock_daemon.py         # ä¸»å®ˆæŠ¤è¿›ç¨‹
â”‚   â”œâ”€â”€ stock_client.py         # è½»é‡çº§å®¢æˆ·ç«¯
â”‚   â””â”€â”€ requirements.txt        # Pythonä¾èµ–
â”œâ”€â”€ media/                      # å›¾æ ‡èµ„æº
â”œâ”€â”€ package.json                # æ’ä»¶æ¸…å•
â”œâ”€â”€ tsconfig.json               # TypeScripté…ç½®
â””â”€â”€ README.md
```

### 2. é…ç½®ç®¡ç†è®¾è®¡

#### 2.1 é…ç½®æ•°æ®ç»“æ„
```typescript
interface StockConfig {
  code: string;           // è‚¡ç¥¨ä»£ç ï¼Œå¦‚ "600000"
  name?: string;          // è‚¡ç¥¨åç§°ï¼ˆè‡ªåŠ¨å¡«å……ï¼‰
  buyPrice: number;       // ä¹°å…¥ä»·æ ¼
  quantity: number;       // ä¹°å…¥æ•°é‡
  enabled: boolean;       // æ˜¯å¦å¯ç”¨ç›‘æ§
  exchange?: string;      // äº¤æ˜“æ‰€åç¼€ï¼Œå¦‚ "sh"ï¼ˆè‡ªåŠ¨åˆ¤æ–­ï¼‰
}

interface PluginConfig {
  version: string;        // é…ç½®ç‰ˆæœ¬
  stocks: StockConfig[];  // è‚¡ç¥¨é…ç½®åˆ—è¡¨
  settings: {
    updateInterval: number;    // æ›´æ–°é—´éš”ï¼ˆç§’ï¼‰ï¼Œé»˜è®¤20
    autoStart: boolean;        // å¯åŠ¨æ—¶è‡ªåŠ¨å¼€å§‹ç›‘æ§
    showNotifications: boolean; // æ˜¾ç¤ºæ¡Œé¢é€šçŸ¥
    priceAlertThreshold: number; // ä»·æ ¼é¢„è­¦é˜ˆå€¼ï¼ˆ%ï¼‰
    dataSourcePriority: 'sina' | 'akshare'; // æ•°æ®æºä¼˜å…ˆçº§
  };
}
```

#### 2.2 é…ç½®å­˜å‚¨
- ä½ç½®ï¼š`~/.trad/config.json`
- æ ¼å¼ï¼šå¸¦JSON SchemaéªŒè¯çš„JSONæ–‡ä»¶
- å¤‡ä»½ï¼šè‡ªåŠ¨åˆ›å»ºå¤‡ä»½æ–‡ä»¶

#### 2.3 é…ç½®ç•Œé¢
**Webviewé…ç½®é¢æ¿å¸ƒå±€**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          è‚¡ç¥¨ç›‘æ§é…ç½®                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è‚¡ç¥¨åˆ—è¡¨                                    â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ä»£ç â”‚ åç§°   â”‚ ä¹°å…¥ä»·â”‚ æ•°é‡ â”‚ å¯ç”¨ â”‚æ“ä½œâ”‚ â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¤ â”‚
â”‚ â”‚600000â”‚æµ¦å‘é“¶è¡Œâ”‚10.50 â”‚100   â”‚âœ…    â”‚âœï¸âœ• â”‚ â”‚
â”‚ â”‚000001â”‚å¹³å®‰é“¶è¡Œâ”‚15.20 â”‚200   â”‚âœ…    â”‚âœï¸âœ• â”‚ â”‚
â”‚ â”‚300750â”‚å®å¾·æ—¶ä»£â”‚200.00â”‚50    â”‚âŒ    â”‚âœï¸âœ• â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜ â”‚
â”‚                                           â”‚
â”‚ [æ·»åŠ è‚¡ç¥¨]                                â”‚
â”‚                                           â”‚
â”‚ å…¨å±€è®¾ç½®                                  â”‚
â”‚  æ›´æ–°é—´éš”: 20 ç§’  [15|20|30|60]          â”‚
â”‚  â–¡ å¯åŠ¨æ—¶è‡ªåŠ¨å¼€å§‹ç›‘æ§                      â”‚
â”‚  â–¡ ä»·æ ¼æ³¢åŠ¨è¶…è¿‡ 5% æ—¶æ˜¾ç¤ºé€šçŸ¥              â”‚
â”‚  æ•°æ®æºä¼˜å…ˆçº§: [æ–°æµªè´¢ç»] [akshare]       â”‚
â”‚                                           â”‚
â”‚ [ä¿å­˜é…ç½®] [å–æ¶ˆ]                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. å®æ—¶æ§åˆ¶åŠŸèƒ½

#### 3.1 æ§åˆ¶ç•Œé¢
**ä½ç½®1ï¼šTreeViewæ ‡é¢˜æ **
```
ğŸ“ˆ TRADè‚¡ç¥¨ç›‘æ§ [è¿è¡Œä¸­]
â”œâ”€â”€ â–¶ å¼€å§‹ç›‘æ§  (å½“åœæ­¢æ—¶æ˜¾ç¤º)
â”œâ”€â”€ â¹ åœæ­¢ç›‘æ§  (å½“è¿è¡Œæ—¶æ˜¾ç¤º)
â”œâ”€â”€ âš™ï¸ é…ç½®
â””â”€â”€ ğŸ”„ æ‰‹åŠ¨åˆ·æ–°
```

**ä½ç½®2ï¼šVSCodeçŠ¶æ€æ **
```
[TRAD] ğŸ“ˆ +2.5% | â–¶ å¼€å§‹ | â¹ åœæ­¢ | âš™ï¸ é…ç½®
```

**ä½ç½®3ï¼šå‘½ä»¤é¢æ¿å‘½ä»¤**
- `trad.startMonitoring` - å¼€å§‹ç›‘æ§
- `trad.stopMonitoring` - åœæ­¢ç›‘æ§
- `trad.addStock` - æ·»åŠ è‚¡ç¥¨
- `trad.openConfig` - æ‰“å¼€é…ç½®
- `trad.refresh` - æ‰‹åŠ¨åˆ·æ–°

#### 3.2 çŠ¶æ€ç®¡ç†
```typescript
enum MonitoringState {
  STOPPED = 'stopped',      // å·²åœæ­¢
  STARTING = 'starting',    // å¯åŠ¨ä¸­
  RUNNING = 'running',      // è¿è¡Œä¸­
  STOPPING = 'stopping',    // åœæ­¢ä¸­
  ERROR = 'error'           // é”™è¯¯çŠ¶æ€
}

class MonitoringManager {
  private state: MonitoringState = MonitoringState.STOPPED;
  private timer: NodeJS.Timeout | null = null;
  private config: PluginConfig;
  private pythonClient: PythonClient;

  async start(): Promise<void> {
    if (this.state !== MonitoringState.STOPPED) return;

    this.state = MonitoringState.STARTING;
    this.updateUI();

    try {
      // 1. å¯åŠ¨Pythonå®ˆæŠ¤è¿›ç¨‹
      const success = await this.pythonClient.startDaemon();
      if (!success) throw new Error('æ— æ³•å¯åŠ¨Pythonå®ˆæŠ¤è¿›ç¨‹');

      // 2. å‘é€é…ç½®ç»™Pythonè¿›ç¨‹
      await this.sendConfigToDaemon();

      // 3. å¼€å§‹å®šæ—¶æ›´æ–°
      this.startUpdateTimer();

      this.state = MonitoringState.RUNNING;
      vscode.window.showInformationMessage('è‚¡ç¥¨ç›‘æ§å·²å¯åŠ¨');

    } catch (error) {
      this.state = MonitoringState.ERROR;
      vscode.window.showErrorMessage(`å¯åŠ¨å¤±è´¥: ${error.message}`);
    }

    this.updateUI();
  }

  async stop(): Promise<void> {
    if (this.state !== MonitoringState.RUNNING) return;

    this.state = MonitoringState.STOPPING;
    this.updateUI();

    // 1. åœæ­¢å®šæ—¶å™¨
    this.stopUpdateTimer();

    // 2. é€šçŸ¥Pythonè¿›ç¨‹åœæ­¢
    await this.pythonClient.sendCommand({ command: 'pause' });

    // 3. æ›´æ–°çŠ¶æ€
    this.state = MonitoringState.STOPPED;
    this.updateUI();

    vscode.window.showInformationMessage('è‚¡ç¥¨ç›‘æ§å·²åœæ­¢');
  }

  private startUpdateTimer(): void {
    const interval = this.config.settings.updateInterval * 1000;
    this.timer = setInterval(async () => {
      if (this.state === MonitoringState.RUNNING) {
        await this.performUpdate();
      }
    }, interval);

    // ç«‹å³æ‰§è¡Œä¸€æ¬¡æ›´æ–°
    this.performUpdate();
  }

  private stopUpdateTimer(): void {
    if (this.timer) {
      clearInterval(this.timer);
      this.timer = null;
    }
  }
}
```

### 4. é€šä¿¡åè®®

#### 4.1 TypeScript â†’ Python å‘½ä»¤
```json
{
  "type": "command",
  "command": "start|stop|pause|resume|update|get_config|set_config",
  "id": "request_id",
  "timestamp": 1640995200000,
  "payload": {
    // å‘½ä»¤ç›¸å…³æ•°æ®
  }
}
```

#### 4.2 Python â†’ TypeScript å“åº”
```json
{
  "type": "response|data|error|status",
  "id": "request_id",
  "timestamp": 1640995200000,
  "data": [
    {
      "code": "600000",
      "name": "æµ¦å‘é“¶è¡Œ",
      "currentPrice": 10.75,
      "buyPrice": 10.50,
      "quantity": 100,
      "profitAmount": 25.00,
      "profitPercent": 2.38,
      "marketValue": 1075.00,
      "costBasis": 1050.00,
      "change": 0.25,
      "changePercent": 2.38,
      "lastUpdate": 1640995200000
    }
  ],
  "error": null,
  "status": "running"
}
```

#### 4.3 Pythonå®ˆæŠ¤è¿›ç¨‹æ¥å£
```python
# stock_daemon.py æ ¸å¿ƒç±»
class StockDaemon:
    def __init__(self):
        self.running = False
        self.update_interval = 20
        self.stock_configs = []
        self.cache = {}
        self.update_task = None

    async def handle_command(self, command_json: str):
        """å¤„ç†æ¥è‡ªæ’ä»¶çš„å‘½ä»¤"""
        command = json.loads(command_json)
        cmd_type = command.get('type')

        if cmd_type == 'command':
            cmd = command.get('command')

            if cmd == 'start':
                await self.start_monitoring()
                return {'status': 'started'}

            elif cmd == 'stop':
                await self.stop_monitoring()
                return {'status': 'stopped'}

            elif cmd == 'pause':
                self.running = False
                return {'status': 'paused'}

            elif cmd == 'resume':
                self.running = True
                return {'status': 'resumed'}

            elif cmd == 'update':
                data = await self.fetch_all_stocks()
                return {'type': 'data', 'data': data}

            elif cmd == 'set_config':
                self.update_config(command['payload'])
                return {'status': 'config_updated'}

    async def start_monitoring(self):
        """å¼€å§‹ç›‘æ§å¾ªç¯"""
        self.running = True

        while self.running:
            try:
                data = await self.fetch_all_stocks()
                # å‘é€æ•°æ®åˆ°æ’ä»¶
                self.send_to_plugin({'type': 'data', 'data': data})

                # ç­‰å¾…æ›´æ–°é—´éš”
                await asyncio.sleep(self.update_interval)

            except Exception as e:
                self.send_to_plugin({'type': 'error', 'error': str(e)})
                await asyncio.sleep(5)  # é”™è¯¯åç­‰å¾…5ç§’é‡è¯•
```

### 5. æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

#### 5.1 æ•°æ®è·å–ä¼˜åŒ–
```python
# æ‰¹é‡è·å–æ›¿ä»£æ–¹æ¡ˆï¼ˆæ¯”akshareå…¨é‡è·å–å¿«10å€ï¼‰
async def batch_fetch_sina(stock_codes):
    """æ‰¹é‡è·å–æ–°æµªè´¢ç»æ•°æ®"""
    # æŒ‰äº¤æ˜“æ‰€åˆ†ç»„
    sh_codes = [code for code in stock_codes if code.startswith(('6', '9'))]
    sz_codes = [code for code in stock_codes if code.startswith(('0', '2', '3'))]

    # æ„é€ æ‰¹é‡URL
    urls = []
    if sh_codes:
        urls.append(f"http://hq.sinajs.cn/list={','.join(f'sh{code}' for code in sh_codes)}")
    if sz_codes:
        urls.append(f"http://hq.sinajs.cn/list={','.join(f'sz{code}' for code in sz_codes)}")

    # å¹¶å‘è¯·æ±‚
    async with aiohttp.ClientSession() as session:
        tasks = [self.fetch_url(session, url) for url in urls]
        results = await asyncio.gather(*tasks, return_exceptions=True)

    return self.parse_batch_results(results)
```

#### 5.2 ç¼“å­˜ç­–ç•¥
- **è‚¡ç¥¨åŸºç¡€ä¿¡æ¯**ï¼šç¼“å­˜5åˆ†é’Ÿï¼ˆåç§°ã€äº¤æ˜“æ‰€ï¼‰
- **å®æ—¶ä»·æ ¼**ï¼šç¼“å­˜20ç§’ï¼ˆä¸æ›´æ–°é—´éš”ä¸€è‡´ï¼‰
- **è®¡ç®—ç»“æœ**ï¼šç¼“å­˜è‡³ä¸‹æ¬¡æ•°æ®æ›´æ–°
- **ç½‘ç»œè¯·æ±‚**ï¼šå¤±è´¥æ—¶ä½¿ç”¨ç¼“å­˜æ•°æ®é™çº§

#### 5.3 æŒ‰éœ€æ›´æ–°ç­–ç•¥
```typescript
// æ™ºèƒ½æ›´æ–°ï¼šåªæ›´æ–°æ´»è·ƒçš„ã€å¯è§çš„è‚¡ç¥¨
class SmartUpdater {
  private activeStocks: Set<string> = new Set();
  private visibleStocks: Set<string> = new Set();

  // ç›‘æ§åˆ—è¡¨ä¸­çš„è‚¡ç¥¨ï¼šæ¯20ç§’æ›´æ–°
  // éæ´»è·ƒè‚¡ç¥¨ï¼šæ¯60ç§’æ›´æ–°æˆ–æš‚åœæ›´æ–°
  // ç•Œé¢éšè—æ—¶ï¼šé™ä½æ›´æ–°é¢‘ç‡æˆ–æš‚åœ

  updateFrequency(stockCode: string): number {
    if (!this.activeStocks.has(stockCode)) {
      return 60 * 1000; // éæ´»è·ƒè‚¡ç¥¨ï¼š60ç§’æ›´æ–°ä¸€æ¬¡
    }

    if (!this.visibleStocks.has(stockCode)) {
      return 30 * 1000; // ä¸å¯è§è‚¡ç¥¨ï¼š30ç§’æ›´æ–°ä¸€æ¬¡
    }

    return 20 * 1000; // æ´»è·ƒä¸”å¯è§ï¼š20ç§’æ›´æ–°ä¸€æ¬¡
  }
}
```

### 6. ç”¨æˆ·æ“ä½œæµç¨‹

#### 6.1 é¦–æ¬¡ä½¿ç”¨æµç¨‹
```
1. å®‰è£…æ’ä»¶ â†’ ä¾§è¾¹æ å‡ºç°"TRADè‚¡ç¥¨ç›‘æ§"
2. ç‚¹å‡»âš™ï¸é…ç½®æŒ‰é’® â†’ æ‰“å¼€é…ç½®Webview
3. æ·»åŠ è‚¡ç¥¨ï¼šå¡«å†™ä»£ç ã€ä¹°å…¥ä»·ã€æ•°é‡
4. è®¾ç½®æ›´æ–°é—´éš”ï¼š20ç§’
5. ç‚¹å‡»"ä¿å­˜é…ç½®"
6. ç‚¹å‡»"å¼€å§‹ç›‘æ§"æŒ‰é’®
```

#### 6.2 æ—¥å¸¸ä½¿ç”¨æµç¨‹
```
å¼€å§‹ç›‘æ§ï¼š
  ç‚¹å‡»"â–¶å¼€å§‹"æŒ‰é’® â†’ çŠ¶æ€å˜ç»¿ â†’ 20ç§’åæ˜¾ç¤ºæ•°æ® â†’ æŒç»­æ›´æ–°

æ·»åŠ è‚¡ç¥¨ï¼š
  ç‚¹å‡»"æ·»åŠ è‚¡ç¥¨" â†’ å¡«å†™è¡¨å• â†’ è‡ªåŠ¨åŠ å…¥ç›‘æ§åˆ—è¡¨

åœæ­¢ç›‘æ§ï¼š
  ç‚¹å‡»"â¹åœæ­¢"æŒ‰é’® â†’ åœæ­¢è·å–æ•°æ® â†’ çŠ¶æ€å˜ç°

ä¸´æ—¶è°ƒæ•´ï¼š
  å³é”®è‚¡ç¥¨ â†’ "æš‚åœç›‘æ§æ­¤è‚¡ç¥¨" â†’ è¯¥è‚¡ç¥¨åœæ­¢æ›´æ–°
```

#### 6.3 å¿«æ·é”®æ”¯æŒ
```json
// package.jsonä¸­çš„å¿«æ·é”®é…ç½®
{
  "key": "ctrl+alt+t s",  // Ctrl+Alt+T, ç„¶åæŒ‰S
  "command": "trad.start",
  "when": "tradViewFocus"
},
{
  "key": "ctrl+alt+t p",  // Ctrl+Alt+T, ç„¶åæŒ‰P
  "command": "trad.stop",
  "when": "tradViewFocus"
},
{
  "key": "ctrl+alt+t a",  // Ctrl+Alt+T, ç„¶åæŒ‰A
  "command": "trad.addStock"
}
```

### 7. é”™è¯¯å¤„ç†å’Œæ¢å¤

#### 7.1 ç½‘ç»œå¼‚å¸¸å¤„ç†
```typescript
class ErrorHandler {
  private retryCount = 0;
  private maxRetries = 3;

  async fetchWithRetry(stockCodes: string[]): Promise<StockData[]> {
    try {
      const data = await this.fetchStocks(stockCodes);
      this.retryCount = 0; // é‡ç½®é‡è¯•è®¡æ•°
      return data;
    } catch (error) {
      this.retryCount++;

      if (this.retryCount >= this.maxRetries) {
        // è¶…è¿‡é‡è¯•æ¬¡æ•°ï¼Œè¿›å…¥é™çº§æ¨¡å¼
        await this.enterDegradedMode();
        throw new Error(`è·å–å¤±è´¥ï¼Œå·²å°è¯•${this.retryCount}æ¬¡`);
      }

      // æŒ‡æ•°é€€é¿é‡è¯•
      const delay = Math.pow(2, this.retryCount) * 1000;
      await this.sleep(delay);
      return this.fetchWithRetry(stockCodes);
    }
  }

  private enterDegradedMode(): void {
    // 1. åˆ‡æ¢åˆ°å¤‡ç”¨æ•°æ®æº
    // 2. å»¶é•¿æ›´æ–°é—´éš”
    // 3. æ˜¾ç¤ºè­¦å‘Šä¿¡æ¯
    vscode.window.showWarningMessage(
      'ç½‘ç»œä¸ç¨³å®šï¼Œå·²åˆ‡æ¢åˆ°å¤‡ç”¨æ•°æ®æºï¼Œæ›´æ–°é—´éš”å»¶é•¿è‡³60ç§’'
    );
  }
}
```

#### 7.2 è¿›ç¨‹å¼‚å¸¸å¤„ç†
```typescript
class ProcessManager {
  private pythonProcess: ChildProcess | null = null;
  private restartCount = 0;
  private maxRestarts = 5;

  async restartDaemon(): Promise<boolean> {
    if (this.restartCount >= this.maxRestarts) {
      vscode.window.showErrorMessage(
        'Pythonå®ˆæŠ¤è¿›ç¨‹å¤šæ¬¡é‡å¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥Pythonç¯å¢ƒå’Œä¾èµ–'
      );
      return false;
    }

    this.restartCount++;

    try {
      await this.stopDaemon();
      await new Promise(resolve => setTimeout(resolve, 1000));
      await this.startDaemon();

      vscode.window.showInformationMessage(
        `Pythonå®ˆæŠ¤è¿›ç¨‹å·²é‡å¯ (${this.restartCount}/${this.maxRestarts})`
      );

      return true;
    } catch (error) {
      vscode.window.showErrorMessage(`é‡å¯å¤±è´¥: ${error.message}`);
      return false;
    }
  }
}
```

### 8. ç•Œé¢è®¾è®¡ç»†èŠ‚

#### 8.1 TreeViewé¡¹ç›®è®¾è®¡
```typescript
class StockTreeItem extends vscode.TreeItem {
  constructor(
    public readonly stockData: StockData,
    public readonly collapsibleState: vscode.TreeItemCollapsibleState
  ) {
    super(stockData.name || stockData.code, collapsibleState);

    // æ ¹æ®ç›ˆäºè®¾ç½®å›¾æ ‡å’Œé¢œè‰²
    if (stockData.profitAmount > 0) {
      this.iconPath = new vscode.ThemeIcon('arrow-up', new vscode.ThemeColor('charts.green'));
    } else if (stockData.profitAmount < 0) {
      this.iconPath = new vscode.ThemeIcon('arrow-down', new vscode.ThemeColor('charts.red'));
    } else {
      this.iconPath = new vscode.ThemeIcon('dash');
    }

    // å·¥å…·æç¤ºæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
    this.tooltip = new vscode.MarkdownString(`
### ${stockData.name} (${stockData.code})
- **å½“å‰ä»·**: ${stockData.currentPrice.toFixed(2)}å…ƒ
- **ä¹°å…¥ä»·**: ${stockData.buyPrice.toFixed(2)}å…ƒ
- **æŒä»“**: ${stockData.quantity}è‚¡
- **ç›ˆäº**: ${stockData.profitAmount.toFixed(2)}å…ƒ (${stockData.profitPercent.toFixed(2)}%)
- **å¸‚å€¼**: ${stockData.marketValue.toFixed(2)}å…ƒ
- **æ›´æ–°æ—¶é—´**: ${new Date(stockData.lastUpdate).toLocaleTimeString()}
    `);

    // æè¿°æ˜¾ç¤ºç›ˆäºä¿¡æ¯
    this.description = `${stockData.profitAmount.toFixed(2)}å…ƒ (${stockData.profitPercent.toFixed(2)}%)`;
  }
}
```

#### 8.2 çŠ¶æ€æ è®¾è®¡
```typescript
class StatusBarManager {
  private statusBarItem: vscode.StatusBarItem;

  constructor() {
    this.statusBarItem = vscode.window.createStatusBarItem(
      vscode.StatusBarAlignment.Right,
      100
    );
  }

  update(state: MonitoringState, summary?: SummaryData) {
    let text = 'TRAD';

    // æ·»åŠ çŠ¶æ€å›¾æ ‡
    switch(state) {
      case MonitoringState.RUNNING:
        text += ' $(play)';
        break;
      case MonitoringState.STOPPED:
        text += ' $(stop)';
        break;
      case MonitoringState.ERROR:
        text += ' $(error)';
        break;
      default:
        text += ' $(sync~spin)';
    }

    // æ·»åŠ æ±‡æ€»ä¿¡æ¯
    if (summary) {
      const sign = summary.totalProfit >= 0 ? '+' : '';
      text += ` ${sign}${summary.totalProfit.toFixed(2)}å…ƒ (${sign}${summary.totalProfitPercent.toFixed(2)}%)`;
    }

    this.statusBarItem.text = text;
    this.statusBarItem.tooltip = 'ç‚¹å‡»åˆ‡æ¢ç›‘æ§çŠ¶æ€';
    this.statusBarItem.command = 'trad.toggleMonitoring';
    this.statusBarItem.show();
  }
}
```

## å®æ–½è®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µï¼šPythonåç«¯æ”¹é€ ï¼ˆ2-3å¤©ï¼‰
1. **é‡æ„æ•°æ®è·å–æ¨¡å—**
   - å®ç°å¼‚æ­¥å¹¶å‘ç‰ˆæœ¬
   - æ·»åŠ ç¼“å­˜è£…é¥°å™¨
   - ä¼˜åŒ–æ•°æ®æºé€‰æ‹©é€»è¾‘

2. **åˆ›å»ºå®ˆæŠ¤è¿›ç¨‹æ¡†æ¶**
   - å®ç°JSON-RPC over stdio
   - æ·»åŠ é…ç½®æ–‡ä»¶ç®¡ç†
   - å®ç°å®šæ—¶æ›´æ–°å¾ªç¯

3. **æ€§èƒ½æµ‹è¯•ä¸ä¼˜åŒ–**
   - å¯¹æ¯”ä¸åŒæ•°æ®æºé€Ÿåº¦
   - æµ‹è¯•å¹¶å‘è¯·æ±‚æ€§èƒ½
   - éªŒè¯ç¼“å­˜æ•ˆæœ

### ç¬¬äºŒé˜¶æ®µï¼šVSCodeæ’ä»¶åŸºç¡€ï¼ˆ3-4å¤©ï¼‰
1. **åˆ›å»ºæ’ä»¶éª¨æ¶**
   ```bash
   npm install -g yo generator-code
   yo code trad-stock-monitor
   ```

2. **å®ç°æ ¸å¿ƒæ¨¡å—**
   - Pythonè¿›ç¨‹ç®¡ç†
   - TreeDataProviderå®ç°
   - é…ç½®ç®¡ç†ç•Œé¢

3. **é›†æˆä¸è°ƒè¯•**
   - è¿›ç¨‹é€šä¿¡æµ‹è¯•
   - å®šæ—¶å™¨é›†æˆ
   - é”™è¯¯å¤„ç†æœºåˆ¶

### ç¬¬ä¸‰é˜¶æ®µï¼šæ§åˆ¶åŠŸèƒ½å®Œå–„ï¼ˆ2-3å¤©ï¼‰
1. **çŠ¶æ€ç®¡ç†å®ç°**
   - å¼€å§‹/åœæ­¢æ§åˆ¶é€»è¾‘
   - çŠ¶æ€åŒæ­¥
   - UIçŠ¶æ€æ›´æ–°

2. **é…ç½®ç®¡ç†å®Œå–„**
   - Webviewé…ç½®ç•Œé¢
   - é…ç½®éªŒè¯
   - å®æ—¶ä¿å­˜

3. **ç”¨æˆ·ä½“éªŒä¼˜åŒ–**
   - å¿«æ·é”®æ”¯æŒ
   - çŠ¶æ€æ é›†æˆ
   - é”™è¯¯æç¤º

### ç¬¬å››é˜¶æ®µï¼šæµ‹è¯•ä¸ä¼˜åŒ–ï¼ˆ1-2å¤©ï¼‰
1. **åŠŸèƒ½æµ‹è¯•**
   - å¤šè‚¡ç¥¨ç›‘æ§æµ‹è¯•
   - ç½‘ç»œå¼‚å¸¸æ¢å¤æµ‹è¯•
   - é•¿æ—¶é—´è¿è¡Œç¨³å®šæ€§æµ‹è¯•

2. **æ€§èƒ½ä¼˜åŒ–**
   - å†…å­˜ä½¿ç”¨ä¼˜åŒ–
   - CPUå ç”¨ä¼˜åŒ–
   - å“åº”é€Ÿåº¦ä¼˜åŒ–

3. **æ–‡æ¡£ç¼–å†™**
   - ç”¨æˆ·ä½¿ç”¨æŒ‡å—
   - å¼€å‘æ–‡æ¡£
   - æ•…éšœæ’é™¤æŒ‡å—

## æ‰©å±•åŠŸèƒ½è·¯çº¿å›¾

### çŸ­æœŸæ‰©å±•ï¼ˆ1-2ä¸ªæœˆï¼‰
1. **ä»·æ ¼é¢„è­¦åŠŸèƒ½**
   - æ¶¨è·Œé˜ˆå€¼è®¾ç½®
   - æ¡Œé¢é€šçŸ¥
   - å£°éŸ³æé†’

2. **åˆ†ç»„ç®¡ç†**
   - æŒ‰æ¿å—åˆ†ç»„
   - è‡ªå®šä¹‰åˆ†ç»„
   - åˆ†ç»„æ±‡æ€»

3. **æ•°æ®å¯¼å‡º**
   - CSVæ ¼å¼å¯¼å‡º
   - ç›ˆäºæŠ¥å‘Š
   - å†å²æ•°æ®

### ä¸­æœŸæ‰©å±•ï¼ˆ3-6ä¸ªæœˆï¼‰
1. **å¤šå¸‚åœºæ”¯æŒ**
   - æ¸¯è‚¡
   - ç¾è‚¡
   - åŸºé‡‘

2. **æŠ€æœ¯åˆ†æ**
   - Kçº¿å›¾æ˜¾ç¤º
   - æŠ€æœ¯æŒ‡æ ‡è®¡ç®—
   - è¶‹åŠ¿åˆ†æ

3. **ç­–ç•¥æé†’**
   - ä»·æ ¼çªç ´æé†’
   - æˆäº¤é‡å¼‚å¸¸æé†’
   - èµ„é‡‘æµå‘æé†’

### é•¿æœŸæ„¿æ™¯ï¼ˆ6ä¸ªæœˆä»¥ä¸Šï¼‰
1. **æ™ºèƒ½æ¨è**
   - åŸºäºæŒä»“æ¨èç›¸å…³è‚¡ç¥¨
   - é£é™©åˆ†æ•£å»ºè®®
   - æ—¶æœºæé†’

2. **æƒ…ç»ªåˆ†æ**
   - æ–°é—»èˆ†æƒ…åˆ†æ
   - ç¤¾äº¤åª’ä½“æƒ…ç»ª
   - å¸‚åœºæƒ…ç»ªæŒ‡æ•°

3. **è‡ªåŠ¨åŒ–äº¤æ˜“æ¥å£**ï¼ˆéœ€è°¨æ…ï¼‰
   - åˆ¸å•†APIå¯¹æ¥
   - æ¡ä»¶å•è®¾ç½®
   - é£é™©æ§åˆ¶

## é™„å½•

### A. æ€§èƒ½æŒ‡æ ‡ç›®æ ‡
- **æ•°æ®æ›´æ–°å»¶è¿Ÿ**ï¼š< 3ç§’ï¼ˆ10åªè‚¡ç¥¨å¹¶å‘ï¼‰
- **å†…å­˜å ç”¨**ï¼š< 50MBï¼ˆPythonè¿›ç¨‹ + Node.jsè¿›ç¨‹ï¼‰
- **CPUå ç”¨**ï¼š< 5%ï¼ˆç©ºé—²æ—¶ï¼‰
- **å¯åŠ¨æ—¶é—´**ï¼š< 3ç§’

### B. å…¼å®¹æ€§è¦æ±‚
- **VSCodeç‰ˆæœ¬**ï¼š>= 1.60.0
- **Pythonç‰ˆæœ¬**ï¼š>= 3.8
- **æ“ä½œç³»ç»Ÿ**ï¼šWindows 10+, macOS 10.15+, Linux

### C. ä¾èµ–åº“åˆ—è¡¨
```json
{
  "Pythonä¾èµ–": [
    "akshare>=1.18.22",
    "pandas>=1.3.0",
    "requests>=2.26.0",
    "aiohttp>=3.8.0",
    "asyncio>=3.4.3"
  ],
  "Node.jsä¾èµ–": [
    "@types/vscode": "^1.60.0",
    "@types/node": "^16.11.0",
    "typescript": "^4.5.0"
  ]
}
```

### D. é…ç½®æ–‡ä»¶ç¤ºä¾‹
```json
{
  "version": "1.0.0",
  "stocks": [
    {
      "code": "600000",
      "name": "æµ¦å‘é“¶è¡Œ",
      "buyPrice": 10.5,
      "quantity": 100,
      "enabled": true,
      "exchange": "sh"
    },
    {
      "code": "000001",
      "name": "å¹³å®‰é“¶è¡Œ",
      "buyPrice": 15.2,
      "quantity": 200,
      "enabled": true,
      "exchange": "sz"
    }
  ],
  "settings": {
    "updateInterval": 20,
    "autoStart": true,
    "showNotifications": true,
    "priceAlertThreshold": 5.0,
    "dataSourcePriority": "sina"
  }
}
```

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼š1.0.0
**æœ€åæ›´æ–°**ï¼š2026-02-10
**è®¾è®¡è€…**ï¼šClaude Code
**åŸºäºè„šæœ¬**ï¼š`stock_profit_calculator.py`

*æ³¨æ„ï¼šæ­¤è®¾è®¡æ–¹æ¡ˆä¸ºåˆæ­¥è§„åˆ’ï¼Œå…·ä½“å®ç°æ—¶å¯èƒ½éœ€è¦æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ã€‚*